name: CI - Go

on:
  workflow_call:
    inputs:
      pr_owner:
        required: false
        type: string
        description: "Pull request author login (used to disable auto-commit for bot PRs)"
    secrets:
      CODECOV_TOKEN:
        required: false
        description: "Codecov token for uploading coverage reports"
      APP_PRIVATE_KEY:
        description: "GitHub App Private Key"
        required: true
  ### Required Workflow Triggers ###
  pull_request:
  merge_group:
  ##################################

concurrency:
  group: "ci-go-${{ github.repository }}-${{ github.ref }}"
  cancel-in-progress: true

permissions:
  contents: read
  packages: read

jobs:
  # Detect if Go files changed to conditionally skip jobs for non-Go changes
  changes:
    name: üîç Detect Changes
    runs-on: ubuntu-latest
    # Ignore Required Workflow runs on the reusable-workflows repo itself
    if: github.repository != 'devantler-tech/reusable-workflows'
    permissions:
      contents: read
      pull-requests: read
    outputs:
      go: ${{ steps.filter.outputs.go }}
      lintable: ${{ steps.filter.outputs.lintable }}
    steps:
      - name: üìÑ Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          persist-credentials: false

      - name: üîç Filter paths
        uses: dorny/paths-filter@de90cc6fb38fc0963ad72b210f1f284cd68cea36 # v3.0.2
        id: filter
        with:
          filters: |
            go:
              - '**/*.go'
              - 'go.mod'
              - 'go.sum'
              - '.golangci.yml'
              - '.golangci.yaml'
            # Files lintable by MegaLinter Go flavor (excluding Go files which are covered above)
            lintable:
              # Languages
              - '**/*.sh'
              - '**/*.bash'
              - '**/*.groovy'
              - '**/*.gradle'
              - '**/*.kt'
              - '**/*.kts'
              - '**/*.sql'
              # Formats
              - '**/*.css'
              - '**/*.scss'
              - '**/*.env'
              - '.env*'
              - '**/*.graphql'
              - '**/*.gql'
              - '**/*.html'
              - '**/*.htm'
              - '**/*.json'
              - '**/*.md'
              - '**/*.markdown'
              - '**/*.proto'
              - '**/*.xml'
              - '**/*.yaml'
              - '**/*.yml'
              # Tooling formats
              - '.github/workflows/**'
              - '**/Dockerfile*'
              - '**/*.dockerfile'
              - '.editorconfig'
              - '**/Chart.yaml'
              - '**/values.yaml'
              - '**/templates/**/*.yaml'
              - '**/templates/**/*.yml'
              # Linter config files (changes to these should trigger linting)
              - '.mega-linter.yml'
              - '.mega-linter.yaml'
              - '.markdownlint.json'
              - '.markdownlint.yaml'
              - '.markdownlint.yml'
              - '.yamllint.yml'
              - '.yamllint.yaml'
              - '.hadolint.yaml'
              - '.hadolint.yml'
              - '.cspell.json'
              - 'cspell.json'
              - '.vale.ini'
              - '.prettierrc'
              - '.prettierrc.*'
              - 'lychee.toml'
              - '.ls-lint.yml'
              - '.secretlintrc.*'
              - '.gitleaksignore'

  tidy:
    name: üì¶ Tidy
    runs-on: ubuntu-latest
    needs: [changes]
    # Skip if no Go files changed or on main/master branches or on reusable-workflows repo
    if: |
      github.repository != 'devantler-tech/reusable-workflows'
      && needs.changes.outputs.go == 'true'
      && github.ref != 'refs/heads/main'
      && github.ref != 'refs/heads/master'
    permissions:
      contents: write
      pull-requests: write
    steps:
      - name: üîë Generate GitHub App Token
        uses: tibdex/github-app-token@3beb63f4bd073e61482598c45c71c1019b59b73a # v2.1.0
        id: generate-token
        with:
          app_id: ${{ vars.APP_ID }}
          private_key: ${{ secrets.APP_PRIVATE_KEY }}
      - name: üìÑ Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          persist-credentials: true
          token: ${{ steps.generate-token.outputs.token }}

      - name: ‚öôÔ∏è Setup Go
        uses: actions/setup-go@4dc6199c7b1a012772edbd06daecab0f50c9053c # v6.1.0
        with:
          go-version: 1.25.5

      - name: üßπ go mod tidy
        run: go mod tidy

      - name: üíæ Commit and push applied linter fixes
        if: |
          !contains(fromJSON('["dependabot[bot]","dependabot","renovate[bot]","renovatebot","renovate"]'), github.event.pull_request.user.login)
          && !contains(fromJSON('["dependabot[bot]","dependabot","renovate[bot]","renovatebot","renovate"]'), inputs.pr_owner)
        uses: stefanzweifel/git-auto-commit-action@04702edda442b2e678b25b537cec683a1493fcb9 # v7.1.0
        with:
          commit_message: "chore: tidy go modules"
          commit_user_name: tidy-bot
          commit_user_email: tidy-bot@users.noreply.github.com

  golangci-lint:
    name: üßπ Lint - golangci-lint
    runs-on: ubuntu-latest
    needs: [changes]
    # Skip if no Go files changed or on reusable-workflows repo
    if: |
      github.repository != 'devantler-tech/reusable-workflows'
      && needs.changes.outputs.go == 'true'
    permissions:
      contents: write
      pull-requests: write
    steps:
      - name: üîë Generate GitHub App Token
        uses: tibdex/github-app-token@3beb63f4bd073e61482598c45c71c1019b59b73a # v2.1.0
        id: generate-token
        with:
          app_id: ${{ vars.APP_ID }}
          private_key: ${{ secrets.APP_PRIVATE_KEY }}

      - name: üìÑ Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          persist-credentials: true
          token: ${{ steps.generate-token.outputs.token }}

      - name: ‚öôÔ∏è Setup Go
        uses: actions/setup-go@4dc6199c7b1a012772edbd06daecab0f50c9053c # v6.1.0
        with:
          go-version: 1.25.5

      - name: üßπ Run golangci-lint
        id: golangci-lint
        uses: golangci/golangci-lint-action@1e7e51e771db61008b38414a730f564565cf7c20 # v9.2.0
        with:
          version: v2.6.2
          args: --fix

      - name: üíæ Commit and push applied linter fixes
        if: |
          !contains(fromJSON('["dependabot[bot]","dependabot","renovate[bot]","renovatebot","renovate"]'), github.event.pull_request.user.login)
          && !contains(fromJSON('["dependabot[bot]","dependabot","renovate[bot]","renovatebot","renovate"]'), inputs.pr_owner)
        uses: stefanzweifel/git-auto-commit-action@04702edda442b2e678b25b537cec683a1493fcb9 # v7.1.0
        with:
          commit_message: "chore: apply golangci-lint fixes"
          commit_user_name: golangci-lint-bot
          commit_user_email: golangci-lint-bot@users.noreply.github.com

      # - name: ü§ñ Prompt Copilot to fix remaining lint errors
      #   if: failure() && steps.golangci-lint.outcome == 'failure'
      #   uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8.0.0
      #   with:
      #     github-token: ${{ steps.generate-token.outputs.token }}
      #     script: |
      #       // Only create comment if running in a pull request context
      #       if (!context.payload.pull_request) {
      #         console.log('Not a pull request context, skipping comment creation');
      #         return;
      #       }
      #
      #       const copilotPromptBody = '@copilot fix all golangci-lint issues';
      #       const owner = context.repo.owner;
      #       const repo = context.repo.repo;
      #       const issueNumber = context.payload.pull_request.number;
      #
      #       // Check for an existing Copilot prompt comment to avoid duplicates
      #       const { data: comments } = await github.rest.issues.listComments({
      #         owner,
      #         repo,
      #         issue_number: issueNumber,
      #         per_page: 100,
      #       });
      #
      #       const existingPrompt = comments.find((comment) => {
      #         if (!comment || !comment.body) {
      #           return false;
      #         }
      #         // Match on exact body; adjust if the prompt format changes
      #         return comment.body.trim() === copilotPromptBody;
      #       });
      #
      #       if (existingPrompt) {
      #         console.log('Copilot prompt comment already exists, skipping creation');
      #         return;
      #       }
      #
      #       await github.rest.issues.createComment({
      #         owner,
      #         repo,
      #         issue_number: issueNumber,
      #         body: copilotPromptBody,
      #       });
      #       console.log('Posted comment to prompt Copilot');

  lint:
    name: üßπ Lint - mega-linter
    runs-on: ubuntu-latest
    needs: [changes]
    # Run if Go files OR other lintable files changed (markdown, yaml, json, etc.)
    if: |
      github.repository != 'devantler-tech/reusable-workflows'
      && (needs.changes.outputs.go == 'true' || needs.changes.outputs.lintable == 'true')
    permissions:
      contents: write
      issues: write
      pull-requests: write
    steps:
      - name: üîë Generate GitHub App Token
        uses: tibdex/github-app-token@3beb63f4bd073e61482598c45c71c1019b59b73a # v2.1.0
        id: generate-token
        with:
          app_id: ${{ vars.APP_ID }}
          private_key: ${{ secrets.APP_PRIVATE_KEY }}

      - name: üìÑ Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          persist-credentials: true
          token: ${{ steps.generate-token.outputs.token }}

      - name: ‚öôÔ∏è Setup Go
        uses: actions/setup-go@4dc6199c7b1a012772edbd06daecab0f50c9053c # v6.1.0
        with:
          go-version: 1.25.5

      - name: üßπ Lint
        id: ml
        uses: oxsecurity/megalinter/flavors/go@55a59b24a441e0e1943080d4a512d827710d4a9d # v9.2.0
        env:
          VALIDATE_ALL_CODEBASE: true
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          APPLY_FIXES: all
          APPLY_FIXES_EVENT: all
          APPLY_FIXES_MODE: commit

      - name: Commit and push applied linter fixes
        if: |
          !contains(fromJSON('["dependabot[bot]","dependabot","renovate[bot]","renovatebot","renovate"]'), github.event.pull_request.user.login)
          && !contains(fromJSON('["dependabot[bot]","dependabot","renovate[bot]","renovatebot","renovate"]'), inputs.pr_owner)
        uses: stefanzweifel/git-auto-commit-action@04702edda442b2e678b25b537cec683a1493fcb9 # v7.1.0
        with:
          commit_message: "chore: Apply megalinter fixes"
          commit_user_name: megalinter-bot
          commit_user_email: 129584137+megalinter-bot@users.noreply.github.com

      # - name: ü§ñ Prompt Copilot to fix remaining mega-linter errors
      #   if: failure() && steps.ml.outcome == 'failure'
      #   uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8.0.0
      #   with:
      #     github-token: ${{ steps.generate-token.outputs.token }}
      #     script: |
      #       // Only create comment if running in a pull request context
      #       if (!context.payload.pull_request) {
      #         console.log('Not a pull request context, skipping comment creation');
      #         return;
      #       }
      #
      #       const issueNumber = context.payload.pull_request.number;
      #       const copilotPromptBody = '@copilot fix all mega-linter issues';
      #
      #       // Check for an existing Copilot prompt comment to avoid duplicates
      #       const { data: comments } = await github.rest.issues.listComments({
      #         owner: context.repo.owner,
      #         repo: context.repo.repo,
      #         issue_number: issueNumber,
      #         per_page: 100,
      #       });
      #
      #       const existingPrompt = comments.find((comment) => {
      #         if (!comment || !comment.body) {
      #           return false;
      #         }
      #         // Match on exact body; adjust if the prompt format changes
      #         return comment.body.trim() === copilotPromptBody;
      #       });
      #
      #       if (existingPrompt) {
      #         console.log('Copilot prompt comment already exists on this pull request, skipping creation');
      #         return;
      #       }
      #
      #       await github.rest.issues.createComment({
      #         owner: context.repo.owner,
      #         repo: context.repo.repo,
      #         issue_number: issueNumber,
      #         body: copilotPromptBody,
      #       });
      #       console.log('Posted comment to prompt Copilot');

  build:
    name: üèóÔ∏è Build
    runs-on: ubuntu-latest
    needs: [changes]
    # Skip if no Go files changed or on reusable-workflows repo
    if: |
      github.repository != 'devantler-tech/reusable-workflows'
      && needs.changes.outputs.go == 'true'
    permissions:
      contents: write
    steps:
      - name: üìë Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          persist-credentials: false

      - name: ‚öôÔ∏è Setup Go
        uses: actions/setup-go@4dc6199c7b1a012772edbd06daecab0f50c9053c # v6.1.0
        with:
          go-version: 1.25.5

      - name: üõ†Ô∏è Build
        run: go build -v ./...

  test:
    name: üß™ Test
    runs-on: ubuntu-latest
    needs: [changes]
    # Skip if no Go files changed or on reusable-workflows repo
    if: |
      github.repository != 'devantler-tech/reusable-workflows'
      && needs.changes.outputs.go == 'true'
    permissions:
      contents: write
    steps:
      - name: üìë Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          persist-credentials: false

      - name: ‚öôÔ∏è Setup Go
        uses: actions/setup-go@4dc6199c7b1a012772edbd06daecab0f50c9053c # v6.1.0
        with:
          go-version: 1.25.5

      - name: üß™ Test
        run: |
          go test ./...

  coverage:
    name: üìä Code Coverage
    runs-on: ubuntu-latest
    needs: [changes]
    # Skip if no Go files changed or on reusable-workflows repo
    if: |
      github.repository != 'devantler-tech/reusable-workflows'
      && needs.changes.outputs.go == 'true'
    permissions:
      contents: write
    steps:
      - name: üìë Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          persist-credentials: false

      - name: ‚öôÔ∏è Setup Go
        uses: actions/setup-go@4dc6199c7b1a012772edbd06daecab0f50c9053c # v6.1.0
        with:
          go-version: 1.25.5

      - name: üë®üèª‚Äçüîß Enable covdata (temp) see https://github.com/golang/go/issues/75031
        run: go env -w GOTOOLCHAIN=go1.25.0+auto

      - name: üìÑ Generate coverage
        run: |
          go test -race -coverprofile=coverage.txt -covermode=atomic ./...

      - name: üìÑ Upload coverage to Codecov
        uses: codecov/codecov-action@671740ac38dd9b0130fbe1cec585b89eea48d3de # v5.5.2
        with:
          token: ${{ secrets.CODECOV_TOKEN }}

  # Status job for required checks - always runs and reports success if all jobs passed or were skipped
  ci-go-status:
    name: ‚úÖ CI - Go Status
    runs-on: ubuntu-latest
    needs: [changes, tidy, golangci-lint, lint, build, test, coverage]
    if: |
      always()
      && github.repository != 'devantler-tech/reusable-workflows'
    steps:
      - name: Check CI status
        shell: bash
        run: |
          set -Eeuo pipefail
          echo "Go changes detected: $GO_CHANGES"
          echo "Lintable changes detected: $LINTABLE_CHANGES"
          echo "Job results:"
          echo "  tidy: $TIDY_RESULT"
          echo "  golangci-lint: $LINT1_RESULT"
          echo "  mega-linter: $LINT2_RESULT"
          echo "  build: $BUILD_RESULT"
          echo "  test: $TEST_RESULT"
          echo "  coverage: $COVERAGE_RESULT"

          # Track if any relevant changes were detected
          HAS_RELEVANT_CHANGES="false"
          if [[ "$GO_CHANGES" == "true" ]] || [[ "$LINTABLE_CHANGES" == "true" ]]; then
            HAS_RELEVANT_CHANGES="true"
          fi

          # If no relevant changes, all jobs should be skipped - that's success
          if [[ "$HAS_RELEVANT_CHANGES" != "true" ]]; then
            echo "‚úÖ No relevant files changed - CI skipped successfully"
            exit 0
          fi

          # Check Go-specific jobs only if Go files changed
          if [[ "$GO_CHANGES" == "true" ]]; then
            for result in "$TIDY_RESULT" "$LINT1_RESULT" "$BUILD_RESULT" "$TEST_RESULT" "$COVERAGE_RESULT"; do
              case "$result" in
                success|skipped)
                  ;;
                *)
                  echo "‚ùå One or more Go CI jobs failed"
                  exit 1
                  ;;
              esac
            done
          fi

          # Check mega-linter if any lintable files changed (including Go)
          if [[ "$GO_CHANGES" == "true" ]] || [[ "$LINTABLE_CHANGES" == "true" ]]; then
            case "$LINT2_RESULT" in
              success|skipped)
                ;;
              *)
                echo "‚ùå MegaLinter job failed"
                exit 1
                ;;
            esac
          fi

          echo "‚úÖ All CI jobs passed"
        env:
          GO_CHANGES: ${{ needs.changes.outputs.go }}
          LINTABLE_CHANGES: ${{ needs.changes.outputs.lintable }}
          TIDY_RESULT: ${{ needs.tidy.result }}
          LINT1_RESULT: ${{ needs.golangci-lint.result }}
          LINT2_RESULT: ${{ needs.lint.result }}
          BUILD_RESULT: ${{ needs.build.result }}
          TEST_RESULT: ${{ needs.test.result }}
          COVERAGE_RESULT: ${{ needs.coverage.result }}
