name: CI - Go

on:
  workflow_call:
    inputs:
      working-directory:
        required: false
        type: string
        default: "./"
        description: "Working directory for Go commands (e.g., 'src' if go.mod is in src/)"
    secrets:
      CODECOV_TOKEN:
        required: false
        description: "Codecov token for uploading coverage reports"

permissions:
  contents: read
  packages: read

jobs:
  lint-golangci-lint:
    name: ğŸ§¹ Lint - golangci-lint
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write
      pull-requests: write
    steps:
      - name: ğŸ“„ Checkout
        uses: actions/checkout@93cb6efe18208431cddfb8368fd83d5badbf9bfd # v5.0.1
        with:
          persist-credentials: false
          fetch-depth: 0

      - name: â™»ï¸ Cache Go modules
        uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830 # v4.3.0
        with:
          path: |
            ~/.cache/go-build
            ~/go/pkg/mod
          key: ${{ runner.os }}-go-${{ hashFiles(format('{0}**/go.sum', inputs.working-directory)) }}
          restore-keys: |
            ${{ runner.os }}-go-

      - name: âš™ï¸ Setup Go
        uses: actions/setup-go@44694675825211faa026b3c33043df3e48a5fa00 # v6.0.0
        with:
          go-version: 1.25.4
          cache-dependency-path: ${{ inputs.working-directory }}/go.sum

      - name: ğŸ”§ Run golangci-lint
        uses: golangci/golangci-lint-action@0a35821d5c230e903fcfe077583637dea1b27b47 # v9.0.0
        with:
          version: latest
          working-directory: ${{ inputs.working-directory }}

  lint-mega-linter:
    name: ğŸ§¹ Lint - mega-linter
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write
      pull-requests: write
    steps:
      - name: ğŸ“„ Checkout
        uses: actions/checkout@93cb6efe18208431cddfb8368fd83d5badbf9bfd # v5.0.1
        with:
          persist-credentials: true
          fetch-depth: 0

      - name: ğŸ§¹ Lint
        uses: oxsecurity/megalinter/flavors/go@62c799d895af9bcbca5eacfebca29d527f125a57 # v9.1.0
        env:
          VALIDATE_ALL_CODEBASE: true
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          APPLY_FIXES: all
          APPLY_FIXES_EVENT: all
          APPLY_FIXES_MODE: commit

  test:
    name: ğŸ§ª Test
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: ğŸ“‘ Checkout
        uses: actions/checkout@93cb6efe18208431cddfb8368fd83d5badbf9bfd # v5.0.1
        with:
          ref: ${{ github.head_ref }}
          persist-credentials: true

      - name: â™»ï¸ Cache Go modules
        uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830 # v4.3.0
        with:
          path: |
            ~/.cache/go-build
            ~/go/pkg/mod
          key: ${{ runner.os }}-go-${{ hashFiles(format('{0}**/go.sum', inputs.working-directory)) }}
          restore-keys: |
            ${{ runner.os }}-go-

      - name: âš™ï¸ Setup Go
        uses: actions/setup-go@44694675825211faa026b3c33043df3e48a5fa00 # v6.0.0
        with:
          go-version: 1.25.4
          cache-dependency-path: ${{ inputs.working-directory }}/go.sum

      - name: â¬‡ï¸ Install dependencies
        working-directory: ${{ inputs.working-directory }}
        run: |
          go get .

      - name: ğŸ› ï¸ Build
        working-directory: ${{ inputs.working-directory }}
        run: go build -v ./...

      - name: ğŸ§ª Test
        working-directory: ${{ inputs.working-directory }}
        run: |
          go test -parallel 100 -p 16 ./...

      - name: ğŸ‘¨ğŸ»â€ğŸ”§ Enable covdata (temp) see https://github.com/golang/go/issues/75031
        run: go env -w GOTOOLCHAIN=go1.25.0+auto

      - name: ğŸ“„ Generate coverage
        working-directory: ${{ inputs.working-directory }}
        run: |
          go test -race -parallel 100 -p 16 -coverprofile=coverage.txt -covermode=atomic ./...

      - name: ğŸ“„ Upload coverage to Codecov
        uses: codecov/codecov-action@5a1091511ad55cbe89839c7260b706298ca349f7 # v5.5.1
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
